<!DOCTYPE html>
<html lang="de" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bestenliste</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            height: 100vh;
            margin: 0;
        }

        #leaderboard {
            background: #ffffff63;
            border-radius: 8px;
            box-shadow: 2px 0 9px 6px rgb(255 255 255 / 40%);
            width: 75vw;
            font-size: 2rem;
            max-height: 100vh;
            overflow: hidden;
        }

        .header {
            > div#desc {
                display: flex;
                justify-content: space-between;
            }

            text-align: center;
            font-weight: bold;
            border-bottom: 2px solid #ccc;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .competitor {
            display: flex;
            justify-content: space-between;
            padding: 10px;
        }

        .name {
            width: 75%;
            text-align: left;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            padding-left: 10px;
        }

        .points {
            width: 25%;
            text-align: right;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            padding-right: 10px;
        }

    </style>
</head>
<body style="background-image: url('bg.jpg')">
<div id="leaderboard">

    <div class="header">
        <div style="font-size: larger">Bestenliste</div>
        <div id="desc">
            <div class="name">Name</div>
            <div class="points">Geld</div>
        </div>
    </div>
</div>

<script>
    const bgmVolume = 1; // max 1

    async function fetchLeaderboard() {
        const response = await fetch('lb.json');
        const data = await response.json();
        data.sort((a, b) => b.money - a.money);
        const leaderboardDiv = document.getElementById('leaderboard');
        // Clear only the competitor entries, keeping the header intact
        const competitorsDiv = document.createElement('div');
        data.forEach((competitor, index) => {
            const competitorDiv = document.createElement('div');
            competitorDiv.className = 'competitor';
            // Apply light gray background for even indexed competitors
            if (index % 2 === 0) {
                competitorDiv.style.backgroundColor = '#f0f0f063'; // Light gray
            }
            let [whole, decimal] = parseFloat(competitor.money).toFixed(2).split('.');

            // Format the whole part by adding dots every three digits
            whole = whole.replace(/\B(?=(\d{3})+(?!\d))/g, ".");

            if (decimal.includes("e"))
                decimal = parseFloat("0." + decimal.substring(0, Math.min(decimal.indexOf("e"), 4))).toString().substring(2) + (decimal.substring(decimal.indexOf("e"))).replace("+", "^");

            competitorDiv.innerHTML = `<div class="name">${competitor.name}</div><div class="points">${decimal ? `${whole},${decimal}` : whole}&euro;</div>`;
            competitorsDiv.appendChild(competitorDiv);
        });

        // Remove old competitors and append new ones
        leaderboardDiv.querySelectorAll('.competitor').forEach(div => div.remove());
        leaderboardDiv.appendChild(competitorsDiv);
    }

    fetchLeaderboard();
    setInterval(fetchLeaderboard, 1000);

    let bgmStarted = false;
    let audioContext, audioBufferStart, audioBufferLoop, sourceNode;
    let audioLoaded = false;

    function loadAudio() {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        loadBuffer("/leaderboard/Bgm_start.mp3")
            .then((buffer) => {
                audioBufferStart = buffer;
                return loadBuffer("/leaderboard/Bgm_loop.mp3");
            })
            .then((buffer) => {
                audioBufferLoop = buffer;
                audioLoaded = true;
            });
    }

    function loadBuffer(url) {
        return new Promise((resolve, reject) => {
            const request = new XMLHttpRequest();
            request.open("GET", url, true);
            request.responseType = "arraybuffer";

            request.onload = function () {
                audioContext.decodeAudioData(
                    request.response,
                    function (buffer) {
                        resolve(buffer);
                    },
                    reject,
                );
            };
            request.send();
        });
    }

    loadAudio();

    function startBgm(buffer) {
        if (audioLoaded === false) return;
        if (buffer) {
            const gainNode = audioContext.createGain();
            gainNode.gain.setValueAtTime(bgmVolume, 0);
            sourceNode = audioContext.createBufferSource();
            sourceNode.buffer = buffer;
            sourceNode.connect(gainNode);
            gainNode.connect(audioContext.destination);
            sourceNode.start(0, 0);
            sourceNode.onended = () => {
                if (buffer === audioBufferStart) {
                    startBgm(audioBufferLoop);
                } else {
                    startBgm(audioBufferLoop);
                }
            };
        }
    }

    document.addEventListener("click", startBgmListener);
    document.addEventListener("keydown", startBgmListener);
    document.addEventListener("touchstart", startBgmListener);

    function startBgmListener() {
        if (bgmStarted === true) return;
        bgmStarted = true;
        if (audioLoaded === true) startBgm(audioBufferStart);
        else {
            const int = setInterval(() => {
                if (audioLoaded === true) {
                    startBgm(audioBufferStart);
                    clearInterval(int);
                }
            }, 100);
        }
    }
</script>
</body>
</html>